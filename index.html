function doPost(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      return ContentService.createTextOutput("Error: No postData received")
                           .setMimeType(ContentService.MimeType.TEXT);
    }

    const sheet = SpreadsheetApp.openById('17-AvOYR4rPJAxJGLpJl9J9_UIL348PKc1F3UDOmxFXk')
                      .getSheetByName('Formulir');

    const data = JSON.parse(e.postData.contents);

    const ktpBlob = Utilities.newBlob(
      Utilities.base64Decode(data.ktp_file),
      data.ktp_file_type,
      data.ktp_file_name
    );
    const fotoBlob = Utilities.newBlob(
      Utilities.base64Decode(data.foto_file),
      data.foto_file_type,
      data.foto_file_name
    );

    const folderKTP = DriveApp.getFolderById('1y31XU6Ks5AiSjNDHUkDJwS0I9UI4Eqpz');
    const folderFoto = DriveApp.getFolderById('1At5SQCB42L78FQaze0SkrSkGhSbF9ixQ');

    const fileKTP = folderKTP.createFile(ktpBlob);
    const fileFoto = folderFoto.createFile(fotoBlob);

    fileKTP.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    fileFoto.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    const row = [];
    row.push(new Date());
    row.push(data.nama_ktp || '');
    row.push(data.ismu_sulthon || '');
    row.push(data.jenis_kelamin || '');
    row.push(data.tempat_lahir || '');
    row.push(data.tanggal_lahir || '');
    row.push(data.golongan_darah || '');
    row.push(data.alamat || '');
    row.push(data.status_tinggal || '');
    row.push(data.no_wa || '');
    row.push(data.majlis_wilayah || '');
    row.push(data.status_nikah || '');
    row.push(data.nama_pasangan || '');
    row.push(data.jumlah_anak || '');
    row.push(data.jumlah_keluarga || '');
    row.push(data.tinggal_dengan_pasangan || '');
    row.push(data.izin_suami ? 'Ya' : 'Tidak');
    row.push(data.pendidikan || '');

    const pekerjaan = data.pekerjaan === 'lainnya'
      ? (data.pekerjaan_lain || '')
      : (data.pekerjaan || '');
    row.push(pekerjaan);

    row.push(data.keahlian || '');
    row.push(data.penghasilan || '');
    row.push(data.penghasilan_suami || '');
    row.push(data.tahun_gabung || '');
    row.push(data.infaq_msah || '');
    row.push(data.infaq_wilayah || '');
    row.push(data.komitmen_ziswnh ? 'Ya' : 'Tidak');
    row.push(data.konfirmasi_ikrar ? 'Ya' : 'Tidak');
    row.push(data.nama_kontak_darurat || '');
    row.push(data.hubungan_kontak_darurat || '');
    row.push(data.no_kontak_darurat || '');
    row.push(fileKTP.getUrl());
    row.push(fileFoto.getUrl());

    sheet.appendRow(row);

    return ContentService.createTextOutput("Success")
                         .setMimeType(ContentService.MimeType.TEXT);

  } catch (err) {
    Logger.log(err.stack);
    return ContentService.createTextOutput("Error: " + err.message)
                         .setMimeType(ContentService.MimeType.TEXT);
  }
}
