<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Form Registrasi Jamaah MSAH 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center px-4 py-12">
  <div class="bg-white shadow-xl rounded-xl p-8 max-w-3xl w-full">
    <h1 class="text-2xl font-bold text-center mb-6 text-green-800">Form Registrasi Jamaah MSAH 2025</h1>
    <form id="registrasiForm" class="space-y-4">

      <!-- Nama -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap (KTP)</label>
        <input type="text" name="nama" required class="w-full border rounded-lg px-3 py-2" />
      </div>

      <!-- Jenis Kelamin -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin</label>
        <select name="jenis_kelamin" required class="w-full border rounded-lg px-3 py-2">
          <option value="">-- Pilih --</option>
          <option>Laki-laki</option>
          <option>Perempuan</option>
        </select>
      </div>

      <!-- Tempat Lahir -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tempat Lahir</label>
        <input type="text" name="tempat_lahir" required class="w-full border rounded-lg px-3 py-2" />
      </div>

      <!-- Tanggal Lahir -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lahir</label>
        <input type="date" name="tanggal_lahir" required class="w-full border rounded-lg px-3 py-2" />
      </div>

      <!-- Alamat -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Lengkap</label>
        <textarea name="alamat" required class="w-full border rounded-lg px-3 py-2"></textarea>
      </div>

      <!-- Status Tinggal -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Status Tinggal</label>
        <select name="status_tinggal" required class="w-full border rounded-lg px-3 py-2">
          <option value="">-- Pilih --</option>
          <option>Tinggal di Majlis</option>
          <option>Kos / Kontrak Dekat Majlis</option>
          <option>Tinggal di Rumah Sendiri</option>
        </select>
      </div>

      <!-- Golongan Darah -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Golongan Darah</label>
        <select name="golongan_darah" class="w-full border rounded-lg px-3 py-2">
          <option value="">-- Pilih --</option>
          <option>A</option>
          <option>B</option>
          <option>AB</option>
          <option>O</option>
        </select>
      </div>

      <!-- Jumlah Keluarga -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Keluarga Tinggal Serumah</label>
        <input type="number" name="jumlah_keluarga" min="1" required class="w-full border rounded-lg px-3 py-2" />
      </div>
      <!-- No WA -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nomor WhatsApp Aktif</label>
        <input type="text" name="wa" required pattern="^08\d{8,12}$" placeholder="Contoh: 081234567890" class="w-full border rounded-lg px-3 py-2" />
        <p class="text-xs text-gray-500 mt-1">Gunakan awalan 08, bukan +62.</p>
      </div>

      <!-- Status Nikah -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Status Pernikahan</label>
        <select name="status_nikah" id="statusNikah" required class="w-full border rounded-lg px-3 py-2">
          <option value="">-- Pilih --</option>
          <option>Belum Menikah</option>
          <option>Menikah</option>
          <option>Cerai</option>
        </select>
      </div>

      <!-- Penghasilan Suami -->
      <div id="penghasilanSuamiContainer" style="display:none">
        <label class="block text-sm font-medium text-gray-700 mb-1">Penghasilan Suami (jika ada)</label>
        <input type="text" name="penghasilan_suami" class="w-full border rounded-lg px-3 py-2" />
      </div>

      <!-- Infaq Wajib -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Infaq Wajib Majlis Pusat <span class="text-red-600">*</span></label>
        <input type="text" name="infaq" required placeholder="Rp xxx.xxx" class="w-full border rounded-lg px-3 py-2" />
        <p class="text-xs text-gray-500 mt-1">Disetorkan setiap tanggal <strong>28 setiap bulannya</strong></p>
      </div>

      <!-- Upload KTP -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Upload Foto KTP</label>
        <input type="file" id="ktpInput" accept="image/*" required class="w-full border rounded-lg px-3 py-2" />
        <p class="text-xs text-gray-500 mt-1">Pastikan KTP terlihat jelas.</p>
        <img src="https://i.imgur.com/IYtYl4D.png" class="mt-2 w-32 h-auto border rounded" />
      </div>

      <!-- Upload Foto Profil -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Upload Foto Profil</label>
        <input type="file" id="fotoProfilInput" accept="image/*" required class="w-full border rounded-lg px-3 py-2" />
        <p class="text-xs text-gray-500 mt-1">Foto close-up, terlihat jelas.</p>
        <img src="https://i.imgur.com/2u8Zcay.png" class="mt-2 w-32 h-auto border rounded" />
      </div>

      <!-- Tombol Submit -->
      <div class="pt-4">
        <button type="submit" class="w-full bg-green-700 hover:bg-green-800 text-white font-semibold py-2 px-4 rounded-lg">
          Kirim Data
        </button>
      </div>
    </form>
    <!-- Modal Sukses -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-xl text-center shadow-lg w-80">
        <h2 class="text-lg font-semibold mb-4 text-green-700">Berhasil Terkirim!</h2>
        <p class="text-sm text-gray-600 mb-4">Data Anda berhasil disimpan. Admin akan menghubungi via WhatsApp.</p>
        <button onclick="window.location.href='https://wa.me/62816787977'" class="bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded-lg">
          Hubungi Admin
        </button>
      </div>
    </div>

    <script>
      const form = document.getElementById("registrasiForm");
      const successModal = document.getElementById("successModal");
      const statusNikah = document.getElementById("statusNikah");
      const penghasilanContainer = document.getElementById("penghasilanSuamiContainer");

      statusNikah.addEventListener("change", () => {
        const isPerempuan = true; // misalnya, sesuaikan jika ingin pakai gender
        penghasilanContainer.style.display = (statusNikah.value === "Menikah") ? "block" : "none";
      });

      function toBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
        });
      }

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const ktpFile = document.getElementById("ktpInput").files[0];
        const profilFile = document.getElementById("fotoProfilInput").files[0];

        const ktpBase64 = ktpFile ? await toBase64(ktpFile) : "";
        const profilBase64 = profilFile ? await toBase64(profilFile) : "";

        const formData = new FormData(form);
        const jsonData = {};

        formData.forEach((value, key) => {
          jsonData[key] = value;
        });

        jsonData["foto_ktp_base64"] = ktpBase64;
        jsonData["foto_profil_base64"] = profilBase64;

        try {
          const response = await fetch("https://script.google.com/macros/s/AKfycbxRdcp1dEb1315YWDKRQCWQXTasZkR2b_pIqtSNoJOxK5NZYjDxCz_dvGFMC6N3jcO1/exec", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(jsonData)
          });

          const result = await response.json();

          if (result.success) {
            successModal.classList.remove("hidden");
            form.reset();
            penghasilanContainer.style.display = "none";
          } else {
            alert("Gagal mengirim: " + (result.message || "Terjadi kesalahan"));
          }
        } catch (err) {
          alert("Terjadi kesalahan saat mengirim data. Silakan coba lagi.");
          console.error(err);
        }
      });
    </script>
  </body>
</html>
